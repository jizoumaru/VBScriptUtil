Option Explicit

Call Main()

Sub Main()
	Call TestSalsa20()
End Sub

Sub TestSalsa20()
	Dim salsa
	Set salsa = New ClassSalsa20
	
	Call salsa.SetKey(Seq(32))
	Call salsa.SetIV(Seq(8))
	
	Dim message
	message = Seq(1000)
	
	Call salsa.Encrypt(message)
	
	Dim expected
	expected = Array(46,172,13,92,28,82,47,201,222,123,185,162,36,233,90,248,63,202,86,187,111,137,206,197,1,253,246,15,178,228,216,163,87,158,39,92,114,124,241,82,16,97,210,248,210,91,178,138,205,233,55,78,114,7,95,167,221,200,12,217,192,138,133,67,225,123,105,26,157,65,61,202,246,240,116,143,251,193,175,234,203,147,66,55,71,77,154,153,49,20,106,164,221,143,241,184,221,148,193,182,232,209,159,195,133,59,45,233,82,121,15,224,118,173,19,188,144,205,148,205,251,30,249,201,252,146,147,181,7,193,61,100,86,186,26,131,186,75,211,136,16,244,217,181,50,177,82,225,191,145,0,180,107,56,4,7,77,44,221,109,99,205,184,95,112,188,129,168,206,105,210,49,90,4,222,130,157,21,84,197,87,96,27,253,218,154,245,8,73,121,84,12,64,136,175,142,23,22,238,8,249,163,219,25,249,120,72,180,44,191,13,193,35,248,201,46,129,32,40,39,45,226,38,152,29,223,8,96,127,240,7,87,103,194,166,182,102,246,125,138,215,49,28,198,88,13,166,9,211,157,159,250,166,158,225,128,39,65,189,4,167,225,111,173,47,217,2,10,142,217,38,110,40,15,241,224,95,151,97,220,17,1,175,104,237,31,60,173,193,251,141,102,89,182,7,163,6,156,62,70,163,25,128,230,9,201,3,134,48,82,96,99,149,114,41,136,207,204,106,166,99,106,58,157,22,53,67,127,82,17,230,147,176,60,32,1,208,97,68,34,143,227,42,62,50,173,120,79,109,214,49,159,234,248,69,93,128,230,101,32,249,191,99,37,231,9,30,131,166,134,187,202,202,64,199,51,129,65,111,241,252,131,255,69,207,27,132,47,239,89,34,100,104,197,133,66,209,170,120,120,59,247,233,219,65,249,180,74,55,85,114,61,238,80,65,123,187,153,34,13,53,228,215,75,137,69,32,60,153,173,188,172,185,159,241,186,181,151,120,10,145,38,82,136,113,150,203,24,86,73,105,22,142,235,174,251,224,42,3,21,240,152,79,201,247,244,253,234,240,123,98,190,25,178,169,238,177,167,83,140,240,29,92,234,121,33,188,61,4,202,255,163,230,143,81,193,107,58,91,176,143,25,82,78,228,62,177,38,136,45,82,157,28,60,217,183,162,44,47,87,239,211,91,9,31,175,173,137,17,88,241,17,251,56,218,156,165,195,136,181,120,154,247,119,92,116,234,9,150,236,203,32,193,233,28,154,90,232,103,2,47,35,214,188,14,237,58,239,92,120,47,255,234,184,90,41,14,169,218,236,58,93,77,184,64,172,164,120,149,252,61,254,217,239,116,211,22,163,131,156,228,173,105,246,49,179,242,34,179,113,25,105,129,245,68,150,184,90,219,55,144,71,39,36,50,138,135,148,10,148,142,172,42,103,137,72,44,77,25,254,59,174,184,100,227,198,215,196,234,47,100,105,21,231,168,211,175,145,38,160,44,186,179,61,30,130,142,133,204,87,192,112,129,109,126,168,165,76,203,209,214,174,31,207,225,106,141,240,221,135,77,90,65,51,30,43,15,13,62,175,98,205,193,225,219,105,183,170,213,131,47,98,81,144,236,128,64,28,187,56,49,88,66,136,23,253,218,251,138,228,198,4,237,118,91,222,237,172,10,14,184,91,100,202,66,169,203,98,38,198,1,70,26,237,22,241,228,84,234,106,23,128,72,119,210,14,126,232,244,136,167,28,107,51,56,102,9,224,34,9,72,181,2,145,27,56,178,218,196,209,102,46,206,120,192,221,180,95,217,91,177,37,60,98,220,238,106,192,14,91,209,223,102,3,102,153,213,203,138,66,124,89,68,3,72,135,85,180,152,51,122,37,170,156,155,157,30,211,187,61,60,157,42,10,169,116,81,29,126,157,150,124,236,238,208,253,160,51,105,54,157,128,179,209,142,195,148,206,122,91,219,57,201,219,151,201,183,207,101,100,31,1,8,96,245,227,7,203,213,30,156,88,4,172,227,132,45,123,67,240,177,144,21,105,139,10,159,116,222,190,251,239,166,147,8,153,29,113,195,108,80,16,113,114,126,181,90,145,215,216,152,94,81,6,0,129,208,10,94,88,77,89,74,92,148,232,230,105,86,121,100,151,35,145,247,152,0,146,173,72,213,35,4,241,249,216,39,116,13,58,47,63,207,142,96,34,179,208,220,127,7,11,173,205,134,34,118,132,117,58,110,71,89,41,140,17,64,145,97,190)
	
	Call WriteLine(ArrayEquals(expected, message))
End Sub

Function ArrayEquals(a, b)
	If UBound(a) <> UBound(b) Then
		ArrayEquals = False
		Exit Function
	End If
	
	Dim i
	For i = 0 To UBound(a)
		If a(i) <> b(i) Then
			ArrayEquals = False
			Exit Function
		End If
	Next
	
	ArrayEquals = True
End Function

Function I32(n)
	If n > 2147483647 Then
		I32 = n - 4294967296
	ElseIf n < -2147483648 Then
		I32 = n + 4294967296
	Else
		I32 = n
	End If
End Function

Function U32(n)
	If n < 0 Then
		U32 = n + 4294967296
	Else
		U32 = n
	End If
End Function

Function Shr(v, n)
	Shr = I32(Fix(U32(v) / (2 ^ n)))
End Function

Function Shl(v, n)
	Shl = I32((v And ((2 ^ (32 - n)) - 1)) * (2 ^ n))
End Function

Function Rotl(v, n)
	Rotl = Shl(v, n) Or Shr(v, 32 - n)
End Function

Function I8ToI32(a, i)
	I8ToI32 = a(i + 0) Or Shl(a(i + 1), 8) Or Shl(a(i + 2), 16) Or Shl(a(i + 3), 24)
End Function

Class ClassSalsa20
	Private State
	
	Private Sub Class_Initialize()
		ReDim State(15)
	End Sub

	Sub SetKey(b)
		State( 1) = I8ToI32(b,  0)
		State( 2) = I8ToI32(b,  4)
		State( 3) = I8ToI32(b,  8)
		State( 4) = I8ToI32(b, 12)
		State(11) = I8ToI32(b, 16)
		State(12) = I8ToI32(b, 20)
		State(13) = I8ToI32(b, 24)
		State(14) = I8ToI32(b, 28)
		State( 0) = 1634760805
		State( 5) = 857760878
		State(10) = 2036477234
		State(15) = 1797285236
	End Sub
	
	Sub SetIV(b)
		State( 6) = I8ToI32(b, 0)
		State( 7) = I8ToI32(b, 4)
		State( 8) = 0
		State( 9) = 0
	End Sub
	
	Sub Encrypt(m)
		Dim j
		j = 0
		
		Dim b
		ReDim b(63)
		
		Dim l
		For l = UBound(m) To 0 Step -64
			Call Stir(b)
			Call CountUp()
			
			Dim i
			For i = 0 To 63
				If j > UBound(m) Then
					Exit For
				End If
				
				m(j) = m(j) Xor b(i)
				j = j + 1
			Next
		Next
	End Sub
	
	Sub CountUp()
		State(8) = I32(State(8) + 1)
		
		If State(8) = 0 Then
			State(9) = I32(State(9) + 1)
		End If
	End Sub

	Sub Stir(b)
		Dim x
		ReDim x(15)

		Dim i
		
		For i = 0 To 15
			x(i) = State(i)
		Next

		For i = 20 To 1 Step -2
			x( 4) = x( 4) Xor Rotl(I32(x( 0) + x(12)),  7)
			x( 8) = x( 8) Xor Rotl(I32(x( 4) + x( 0)),  9)
			x(12) = x(12) Xor Rotl(I32(x( 8) + x( 4)), 13)
			x( 0) = x( 0) Xor Rotl(I32(x(12) + x( 8)), 18)
			x( 9) = x( 9) Xor Rotl(I32(x( 5) + x( 1)),  7)
			x(13) = x(13) Xor Rotl(I32(x( 9) + x( 5)),  9)
			x( 1) = x( 1) Xor Rotl(I32(x(13) + x( 9)), 13)
			x( 5) = x( 5) Xor Rotl(I32(x( 1) + x(13)), 18)
			x(14) = x(14) Xor Rotl(I32(x(10) + x( 6)),  7)
			x( 2) = x( 2) Xor Rotl(I32(x(14) + x(10)),  9)
			x( 6) = x( 6) Xor Rotl(I32(x( 2) + x(14)), 13)
			x(10) = x(10) Xor Rotl(I32(x( 6) + x( 2)), 18)
			x( 3) = x( 3) Xor Rotl(I32(x(15) + x(11)),  7)
			x( 7) = x( 7) Xor Rotl(I32(x( 3) + x(15)),  9)
			x(11) = x(11) Xor Rotl(I32(x( 7) + x( 3)), 13)
			x(15) = x(15) Xor Rotl(I32(x(11) + x( 7)), 18)
			x( 1) = x( 1) Xor Rotl(I32(x( 0) + x( 3)),  7)
			x( 2) = x( 2) Xor Rotl(I32(x( 1) + x( 0)),  9)
			x( 3) = x( 3) Xor Rotl(I32(x( 2) + x( 1)), 13)
			x( 0) = x( 0) Xor Rotl(I32(x( 3) + x( 2)), 18)
			x( 6) = x( 6) Xor Rotl(I32(x( 5) + x( 4)),  7)
			x( 7) = x( 7) Xor Rotl(I32(x( 6) + x( 5)),  9)
			x( 4) = x( 4) Xor Rotl(I32(x( 7) + x( 6)), 13)
			x( 5) = x( 5) Xor Rotl(I32(x( 4) + x( 7)), 18)
			x(11) = x(11) Xor Rotl(I32(x(10) + x( 9)),  7)
			x( 8) = x( 8) Xor Rotl(I32(x(11) + x(10)),  9)
			x( 9) = x( 9) Xor Rotl(I32(x( 8) + x(11)), 13)
			x(10) = x(10) Xor Rotl(I32(x( 9) + x( 8)), 18)
			x(12) = x(12) Xor Rotl(I32(x(15) + x(14)),  7)
			x(13) = x(13) Xor Rotl(I32(x(12) + x(15)),  9)
			x(14) = x(14) Xor Rotl(I32(x(13) + x(12)), 13)
			x(15) = x(15) Xor Rotl(I32(x(14) + x(13)), 18)
		Next
		
		For i = 0 To 15
			x(i) = I32(x(i) + State(i))
			b(i * 4 + 0) = x(i) And &HFF
			b(i * 4 + 1) = Shr(x(i),  8) And &HFF
			b(i * 4 + 2) = Shr(x(i), 16) And &HFF
			b(i * 4 + 3) = Shr(x(i), 24) And &HFF
		Next
	End Sub
End Class

Function Seq(n)
	Dim a
	ReDim a(n - 1)
	
	Dim i
	For i = 0 To UBound(a)
		a(i) = i And &HFF
	Next
	
	Seq = a
End Function

Sub WriteLine(s)
	Call WScript.StdOut.WriteLine(s)
End Sub
